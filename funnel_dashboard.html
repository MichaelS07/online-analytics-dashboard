<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Funnel Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #E1F3FF;
            color: #003F5C;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .kpi-card {
            border-left: 5px solid #6B9DB3;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 350px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .select-group label {
            font-weight: 600;
            color: #003F5C;
            margin-right: 0.5rem;
        }
        .select-group select {
            padding: 0.5rem;
            border: 1px solid #A7D1E3;
            border-radius: 0.25rem;
            background-color: #fff;
            color: #003F5C;
            cursor: pointer;
        }
        .funnel-step-item {
            display: grid;
            grid-template-columns: 1fr minmax(120px,1fr) minmax(120px,1fr);
            gap: 2rem;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #E1F3FF;
        }
        .funnel-step-item:last-child {
            border-bottom: none;
        }
        .btn-primary {
            background-color: #003F5C;
            color: #E1F3FF;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary:hover {
            background-color: #366E8A;
        }
        .btn-secondary {
            background-color: #A7D1E3;
            color: #003F5C;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #6B9DB3;
        }
    </style>
</head>
<body class="antialiased text-gray-800">
    <div class="container mx-auto p-4 sm:p-8">

        <nav class="mb-8">
            <a href="index.html" class="btn-secondary">
                ← Home
            </a>
        </nav>
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-2">Interactive Funnel Dashboard</h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">Upload your CSV data to visualize your conversion funnel and identify drop-off points.</p>
        </header>

        <section id="data-input" class="card">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                <label for="csv-upload" class="block text-xl font-semibold mb-2 md:mb-0 text-gray-900">Upload Your Funnel Data (CSV)</label>
                <input type="file" id="csv-upload" accept=".csv" class="cursor-pointer text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-[#A7D1E3] file:text-[#003F5C]
                    hover:file:bg-[#6B9DB3]">
            </div>
            <p id="file-status" class="text-sm text-gray-500">Please upload a CSV file with columns: `Year`, `Month`, `total_sessions`, `total_carts`, `total_checkouts`, `total_orders_placed`, and `total_conversion Rate`.</p>
        </section>

        <section id="dashboard-content" class="hidden">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
                <h2 class="text-3xl font-bold text-gray-900">Key Metrics Overview</h2>
                <div class="flex space-x-4">
                    <div class="select-group">
                        <label for="year-select">Select Year:</label>
                        <select id="year-select"></select>
                    </div>
                    <div class="select-group">
                        <label for="month-select">Select Month:</label>
                        <select id="month-select"></select>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="card kpi-card">
                    <h3 class="text-xl font-semibold text-[#366E8A]">Sessions</h3>
                    <p id="kpi-sessions" class="text-3xl font-bold mt-2">0</p>
                    <div class="flex flex-col space-y-1 text-sm mt-2">
                        <span id="trend-mom-sessions" class="flex items-center font-bold"></span>
                        <span id="trend-yoy-sessions" class="flex items-center font-bold"></span>
                    </div>
                </div>
                <div class="card kpi-card">
                    <h3 class="text-xl font-semibold text-[#366E8A]">Checkouts Completed</h3>
                    <p id="kpi-checkouts" class="text-3xl font-bold mt-2">0</p>
                    <div class="flex flex-col space-y-1 text-sm mt-2">
                        <span id="trend-mom-checkouts" class="flex items-center font-bold"></span>
                        <span id="trend-yoy-checkouts" class="flex items-center font-bold"></span>
                    </div>
                </div>
                <div class="card kpi-card">
                    <h3 class="text-xl font-semibold text-[#366E8A]">Conversion Rate</h3>
                    <p id="kpi-conversion-rate" class="text-3xl font-bold mt-2">0%</p>
                    <div class="flex flex-col space-y-1 text-sm mt-2">
                        <span id="trend-mom-conversion-rate" class="flex items-center font-bold"></span>
                        <span id="trend-yoy-conversion-rate" class="flex items-center font-bold"></span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="card">
                    <h3 id="funnel-chart-title" class="text-xl font-semibold text-center mb-4 text-gray-900">Conversion Funnel Breakdown</h3>
                    <div class="chart-container">
                        <canvas id="funnelChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3 id="time-chart-title" class="text-xl font-semibold text-center mb-4 text-gray-900">Conversion Rate Over Time</h3>
                    <div class="chart-container">
                        <canvas id="timeChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="grid grid-cols-[1fr_minmax(120px,1fr)_minmax(120px,1fr)] gap-8 mb-2 items-end">
                    <p class="text-xl font-semibold text-gray-900">Funnel Step Breakdown</p>
                    <p id="current-period-header" class="text-lg font-bold text-gray-700 text-right"></p>
                    <p id="prior-period-header" class="text-lg text-gray-500 text-right"></p>
                </div>
                <div class="space-y-2">
                    <div class="funnel-step-item">
                        <p class="text-lg font-bold text-gray-800">Overall Sessions:</p>
                        <p id="step-sessions-current-period" class="text-lg font-bold text-[#366E8A] text-right">-</p>
                        <p id="step-sessions-prior-period" class="text-lg text-gray-500 text-right">-</p>
                    </div>
                    <div class="funnel-step-item">
                        <p class="text-lg text-gray-600">Sessions → Sessions with cart additions:</p>
                        <p id="step-sessions-to-cart-current-period" class="text-lg font-bold text-[#366E8A] text-right">-</p>
                        <p id="step-sessions-to-cart-prior-period" class="text-lg text-gray-500 text-right">-</p>
                    </div>
                    <div class="funnel-step-item">
                        <p class="text-lg text-gray-600">Sessions with cart additions → Sessions that reached checkout:</p>
                        <p id="step-cart-to-checkout-current-period" class="text-lg font-bold text-[#366E8A] text-right">-</p>
                        <p id="step-cart-to-checkout-prior-period" class="text-lg text-gray-500 text-right">-</p>
                    </div>
                    <div class="funnel-step-item">
                        <p class="text-lg text-gray-600">Sessions that reached checkout → Sessions that completed checkout:</p>
                        <p id="step-checkout-to-purchase-current-period" class="text-lg font-bold text-[#366E8A] text-right">-</p>
                        <p id="step-checkout-to-purchase-prior-period" class="text-lg text-gray-500 text-right">-</p>
                    </div>
                    <div class="funnel-step-item mt-4">
                        <p class="text-lg font-bold text-gray-800">Overall Conversion Rate:</p>
                        <p id="conversion-rate-current-period" class="text-lg font-bold text-[#366E8A] text-right">-</p>
                        <p id="conversion-rate-prior-period" class="text-lg text-gray-500 text-right">-</p>
                    </div>
                </div>
            </div>
        </section>

    </div>
    <script>
        const brilliantBlues = ['#003F5C', '#366E8A', '#6B9DB3', '#A7D1E3', '#E1F3FF'];
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        let rawData = [];
        let groupedData = {}; // { year: { monthIndex: dataObject } }
        let funnelChart, timeChart;

        const fileInput = document.getElementById('csv-upload');
        const fileStatus = document.getElementById('file-status');
        const dashboardContent = document.getElementById('dashboard-content');
        const yearSelect = document.getElementById('year-select');
        const monthSelect = document.getElementById('month-select');
        const currentPeriodHeader = document.getElementById('current-period-header');
        const priorPeriodHeader = document.getElementById('prior-period-header');
        
        const columnMapping = {
            'year': ['Year'],
            'month': ['Month'],
            'sessions': ['sessions', 'visits', 'total_sessions'],
            'sessions_with_cart_additions': ['sessions with cart additions', 'add to cart', 'cart additions', 'total_carts'],
            'sessions_that_reached_checkout': ['sessions that reached checkout', 'reached checkout', 'checkout initiated', 'total_checkouts'],
            'sessions_that_completed_checkout': ['sessions that completed checkout', 'completed checkout', 'conversions', 'total_orders_placed'],
            'conversion_rate': ['conversion rate', 'cr', 'total conversion rate', 'total_conversion Rate']
        };

        function wrapLabel(label, maxWidth) {
            const words = label.split(' ');
            let line = '';
            const lines = [];
            for (let i = 0; i < words.length; i++) {
                const testLine = line + words[i] + ' ';
                if (testLine.length > maxWidth && i > 0) {
                    lines.push(line.trim());
                    line = words[i] + ' ';
                } else {
                    line = testLine;
                }
            }
            lines.push(line.trim());
            return lines;
        }

        const tooltipTitleCallback = (tooltipItems) => {
            const item = tooltipItems[0];
            let label = item.chart.data.labels[item.dataIndex];
            if (Array.isArray(label)) {
                return label.join(' ');
            }
            return label;
        };
        
        const findHeader = (headers, possibleNames) => {
            for (const name of possibleNames) {
                const foundHeader = headers.find(h => h.toLowerCase().replace(/_/g, ' ') === name.toLowerCase().replace(/_/g, ' '));
                if (foundHeader) {
                    return foundHeader;
                }
            }
            return null;
        };

        const processCSV = (text) => {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            const matchedHeaders = {};
            for (const key in columnMapping) {
                const foundHeader = findHeader(headers, columnMapping[key]);
                if (!foundHeader) {
                    throw new Error(`Missing required column for '${key}'. Please check your CSV file.`);
                }
                matchedHeaders[key] = foundHeader;
            }

            const data = lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim());
                const item = {};
                for (const key in matchedHeaders) {
                    const headerIndex = headers.indexOf(matchedHeaders[key]);
                    const value = values[headerIndex];
                    item[key] = isNaN(value) ? value : parseFloat(value);
                }
                return item;
            });
            return data;
        };
        
        const groupDataByYearAndMonth = (data) => {
            const grouped = {};
            data.forEach(item => {
                const year = item.year;
                const monthName = item.month;
                const monthIndex = monthNames.findIndex(m => m.toLowerCase().startsWith(monthName.toLowerCase()));

                if (isNaN(year) || monthIndex === -1) {
                    console.error('Invalid date format detected in row:', item.month, item.year);
                    return; 
                }
                
                if (!grouped[year]) {
                    grouped[year] = {};
                }
                if (!grouped[year][monthIndex]) {
                    grouped[year][monthIndex] = {
                        sessions: 0,
                        sessions_with_cart_additions: 0,
                        sessions_that_reached_checkout: 0,
                        sessions_that_completed_checkout: 0,
                        conversion_rate: 0
                    };
                }

                const aggregatedData = grouped[year][monthIndex];
                aggregatedData.sessions += item.sessions;
                aggregatedData.sessions_with_cart_additions += item.sessions_with_cart_additions;
                aggregatedData.sessions_that_reached_checkout += item.sessions_that_reached_checkout;
                aggregatedData.sessions_that_completed_checkout += item.sessions_that_completed_checkout;
                
                aggregatedData.conversion_rate = aggregatedData.sessions > 0 
                    ? aggregatedData.sessions_that_completed_checkout / aggregatedData.sessions 
                    : 0;
            });
            return grouped;
        };
        
        const getAggregatedYearData = (year) => {
            const yearData = groupedData[year];
            if (!yearData) return null;

            const months = Object.values(yearData);
            
            const totalSessions = months.reduce((sum, m) => sum + m.sessions, 0);
            const totalSessionsWithCart = months.reduce((sum, m) => sum + m.sessions_with_cart_additions, 0);
            const totalSessionsReachedCheckout = months.reduce((sum, m) => sum + m.sessions_that_reached_checkout, 0);
            const totalSessionsCompletedCheckout = months.reduce((sum, m) => sum + m.sessions_that_completed_checkout, 0);
            const totalConversionRate = totalSessions > 0 ? totalSessionsCompletedCheckout / totalSessions : 0;
            
            return {
                sessions: totalSessions,
                sessions_with_cart_additions: totalSessionsWithCart,
                sessions_that_reached_checkout: totalSessionsReachedCheckout,
                sessions_that_completed_checkout: totalSessionsCompletedCheckout,
                conversion_rate: totalConversionRate
            };
        };

        const populateDropdowns = (groupedData) => {
            yearSelect.innerHTML = '';
            monthSelect.innerHTML = '';
            const years = Object.keys(groupedData).sort().reverse();
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            
            const selectedYear = yearSelect.value;
            if (selectedYear) {
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'All';
                monthSelect.appendChild(allOption);

                const months = Object.keys(groupedData[selectedYear]).sort((a, b) => a - b);
                months.forEach(monthIndex => {
                    const option = document.createElement('option');
                    option.value = monthIndex;
                    option.textContent = monthNames[monthIndex];
                    monthSelect.appendChild(option);
                });
            }
        };
        
        const getTrendValue = (currentValue, previousValue) => {
            if (previousValue === 0) return { text: 'New Data', color: 'text-gray-500' };
            const change = (currentValue - previousValue) / previousValue;
            const sign = change >= 0 ? '▲' : '▼';
            const color = change >= 0 ? 'text-green-500' : 'text-red-500';
            return { text: `${sign} ${(Math.abs(change) * 100).toFixed(2)}%`, color: color };
        };

        const getTrendClass = (currentValue, priorValue) => {
            if (priorValue === 0 || currentValue === priorValue) return 'text-gray-500';
            return currentValue > priorValue ? 'text-green-500' : 'text-red-500';
        };

        const updateDashboard = () => {
            const selectedYear = yearSelect.value;
            const selectedMonthIndex = monthSelect.value;
            
            if (!selectedYear || selectedMonthIndex === '' || !groupedData[selectedYear]) {
                dashboardContent.classList.add('hidden');
                return;
            }

            let currentData, priorPeriodData;
            let currentPeriodLabel, priorPeriodLabel;
            
            if (selectedMonthIndex === 'all') {
                currentData = getAggregatedYearData(selectedYear);
                priorPeriodData = getAggregatedYearData(parseInt(selectedYear) - 1);
                currentPeriodLabel = `${selectedYear} Total`;
                priorPeriodLabel = `${parseInt(selectedYear) - 1} Total`;
            } else {
                currentData = groupedData[selectedYear][selectedMonthIndex];
                const previousYear = parseInt(selectedYear) - 1;
                priorPeriodData = groupedData[previousYear] ? groupedData[previousYear][selectedMonthIndex] : null;
                currentPeriodLabel = `${monthNames[selectedMonthIndex]} ${selectedYear}`;
                priorPeriodLabel = priorPeriodData ? `${monthNames[selectedMonthIndex]} ${previousYear}` : `Prior Year`;
            }
            
            if (!currentData) {
                dashboardContent.classList.add('hidden');
                return;
            }

            document.getElementById('kpi-sessions').textContent = currentData.sessions.toLocaleString();
            document.getElementById('kpi-checkouts').textContent = currentData.sessions_that_completed_checkout.toLocaleString();
            document.getElementById('kpi-conversion-rate').textContent = `${(currentData.conversion_rate * 100).toFixed(2)}%`;

            const previousMonthIndex = parseInt(selectedMonthIndex) - 1;
            const previousMonthData = selectedMonthIndex !== 'all' && groupedData[selectedYear] ? groupedData[selectedYear][previousMonthIndex] : null;

            const trendMoMSessions = previousMonthData ? getTrendValue(currentData.sessions, previousMonthData.sessions) : null;
            const trendMoMCheckouts = previousMonthData ? getTrendValue(currentData.sessions_that_completed_checkout, previousMonthData.sessions_that_completed_checkout) : null;
            const trendMoMConversion = previousMonthData ? getTrendValue(currentData.conversion_rate, previousMonthData.conversion_rate) : null;

            document.getElementById('trend-mom-sessions').innerHTML = trendMoMSessions ? `<span class="${trendMoMSessions.color}">${trendMoMSessions.text}</span> vs. Prior Month` : '—';
            document.getElementById('trend-mom-checkouts').innerHTML = trendMoMCheckouts ? `<span class="${trendMoMCheckouts.color}">${trendMoMCheckouts.text}</span> vs. Prior Month` : '—';
            document.getElementById('trend-mom-conversion-rate').innerHTML = trendMoMConversion ? `<span class="${trendMoMConversion.color}">${trendMoMConversion.text}</span> vs. Prior Month` : '—';

            const trendYoYSessions = priorPeriodData ? getTrendValue(currentData.sessions, priorPeriodData.sessions) : null;
            const trendYoYCheckouts = priorPeriodData ? getTrendValue(currentData.sessions_that_completed_checkout, priorPeriodData.sessions_that_completed_checkout) : null;
            const trendYoYConversion = priorPeriodData ? getTrendValue(currentData.conversion_rate, priorPeriodData.conversion_rate) : null;
            
            document.getElementById('trend-yoy-sessions').innerHTML = trendYoYSessions ? `<span class="${trendYoYSessions.color}">${trendYoYSessions.text}</span> vs. Prior Year` : '—';
            document.getElementById('trend-yoy-checkouts').innerHTML = trendYoYCheckouts ? `<span class="${trendYoYCheckouts.color}">${trendYoYCheckouts.text}</span> vs. Prior Year` : '—';
            document.getElementById('trend-yoy-conversion-rate').innerHTML = trendYoYConversion ? `<span class="${trendYoYConversion.color}">${trendYoYConversion.text}</span> vs. Prior Year` : '—';

            document.getElementById('funnel-chart-title').textContent = `Conversion Funnel Breakdown - ${currentPeriodLabel}`;
            document.getElementById('time-chart-title').textContent = `Conversion Rate Over Time - ${selectedYear}`;

            currentPeriodHeader.textContent = currentPeriodLabel;
            priorPeriodHeader.textContent = priorPeriodLabel;

            document.getElementById('step-sessions-current-period').textContent = currentData.sessions.toLocaleString();
            document.getElementById('step-sessions-prior-period').textContent = priorPeriodData ? priorPeriodData.sessions.toLocaleString() : '—';

            const stepSessionsToCartCurrent = document.getElementById('step-sessions-to-cart-current-period');
            const stepCartToCheckoutCurrent = document.getElementById('step-cart-to-checkout-current-period');
            const stepCheckoutToPurchaseCurrent = document.getElementById('step-checkout-to-purchase-current-period');
            const conversionRateCurrent = document.getElementById('conversion-rate-current-period');
            
            const sessionsToCartRate = currentData.sessions > 0 ? (currentData.sessions_with_cart_additions / currentData.sessions) * 100 : 0;
            const cartToCheckoutRate = currentData.sessions_with_cart_additions > 0 ? (currentData.sessions_that_reached_checkout / currentData.sessions_with_cart_additions) * 100 : 0;
            const checkoutToPurchaseRate = currentData.sessions_that_reached_checkout > 0 ? (currentData.sessions_that_completed_checkout / currentData.sessions_that_reached_checkout) * 100 : 0;
            
            stepSessionsToCartCurrent.textContent = `${currentData.sessions_with_cart_additions.toLocaleString()} (${sessionsToCartRate.toFixed(2)}%)`;
            stepCartToCheckoutCurrent.textContent = `${currentData.sessions_that_reached_checkout.toLocaleString()} (${cartToCheckoutRate.toFixed(2)}%)`;
            stepCheckoutToPurchaseCurrent.textContent = `${currentData.sessions_that_completed_checkout.toLocaleString()} (${checkoutToPurchaseRate.toFixed(2)}%)`;
            conversionRateCurrent.textContent = `${(currentData.conversion_rate * 100).toFixed(2)}%`;

            const stepSessionsToCartPrior = document.getElementById('step-sessions-to-cart-prior-period');
            const stepCartToCheckoutPrior = document.getElementById('step-cart-to-checkout-prior-period');
            const stepCheckoutToPurchasePrior = document.getElementById('step-checkout-to-purchase-prior-period');
            const conversionRatePrior = document.getElementById('conversion-rate-prior-period');

            if (priorPeriodData) {
                const priorPeriodSessionsToCartRate = priorPeriodData.sessions > 0 ? (priorPeriodData.sessions_with_cart_additions / priorPeriodData.sessions) * 100 : 0;
                const priorPeriodCartToCheckoutRate = priorPeriodData.sessions_with_cart_additions > 0 ? (priorPeriodData.sessions_that_reached_checkout / priorPeriodData.sessions_with_cart_additions) * 100 : 0;
                const priorPeriodCheckoutToPurchaseRate = priorPeriodData.sessions_that_reached_checkout > 0 ? (priorPeriodData.sessions_that_completed_checkout / priorPeriodData.sessions_that_reached_checkout) * 100 : 0;

                stepSessionsToCartPrior.textContent = `${priorPeriodData.sessions_with_cart_additions.toLocaleString()} (${priorPeriodSessionsToCartRate.toFixed(2)}%)`;
                stepCartToCheckoutPrior.textContent = `${priorPeriodData.sessions_that_reached_checkout.toLocaleString()} (${priorPeriodCartToCheckoutRate.toFixed(2)}%)`;
                stepCheckoutToPurchasePrior.textContent = `${priorPeriodData.sessions_that_completed_checkout.toLocaleString()} (${priorPeriodCheckoutToPurchaseRate.toFixed(2)}%)`;
                conversionRatePrior.textContent = `${(priorPeriodData.conversion_rate * 100).toFixed(2)}%`;
                
                stepSessionsToCartCurrent.className = `text-lg font-bold text-right ${getTrendClass(sessionsToCartRate, priorPeriodSessionsToCartRate)}`;
                stepCartToCheckoutCurrent.className = `text-lg font-bold text-right ${getTrendClass(cartToCheckoutRate, priorPeriodCartToCheckoutRate)}`;
                stepCheckoutToPurchaseCurrent.className = `text-lg font-bold text-right ${getTrendClass(checkoutToPurchaseRate, priorPeriodCheckoutToPurchaseRate)}`;
                conversionRateCurrent.className = `text-lg font-bold text-right ${getTrendClass(currentData.conversion_rate, priorPeriodData.conversion_rate)}`;

            } else {
                stepSessionsToCartPrior.textContent = '—';
                stepCartToCheckoutPrior.textContent = '—';
                stepCheckoutToPurchasePrior.textContent = '—';
                conversionRatePrior.textContent = '—';
                
                stepSessionsToCartCurrent.className = 'text-lg font-bold text-[#366E8A] text-right';
                stepCartToCheckoutCurrent.className = 'text-lg font-bold text-[#366E8A] text-right';
                stepCheckoutToPurchaseCurrent.className = 'text-lg font-bold text-[#366E8A] text-right';
                conversionRateCurrent.className = 'text-lg font-bold text-[#366E8A] text-right';
            }
            updateFunnelChart(currentData);
            if (selectedMonthIndex === 'all') {
                updateTimeChartForYear(groupedData[selectedYear]);
            } else {
                updateTimeChart(groupedData[selectedYear]);
            }

            dashboardContent.classList.remove('hidden');
        };

        const updateFunnelChart = (data) => {
            if (funnelChart) funnelChart.destroy();

            const labels = ['Sessions', 'Added to Cart', 'Reached Checkout', 'Completed Checkout'];
            const counts = [
                data.sessions,
                data.sessions_with_cart_additions,
                data.sessions_that_reached_checkout,
                data.sessions_that_completed_checkout
            ];
            const maxVal = Math.max(...counts);
            const gaps = counts.map(c => (maxVal - c) / 2);
            
            const wrappedLabels = labels.map(label => wrapLabel(label, 16));

            const ctx = document.getElementById('funnelChart').getContext('2d');
            funnelChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: wrappedLabels,
                    datasets: [{
                        label: 'Users',
                        data: counts,
                        backgroundColor: brilliantBlues[1],
                        barPercentage: 1.0,
                        categoryPercentage: 1.0,
                    }, {
                        label: 'Left Padding',
                        data: gaps,
                        backgroundColor: 'rgba(0, 0, 0, 0)',
                        barPercentage: 1.0,
                        categoryPercentage: 1.0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            stacked: true,
                            display: false,
                        },
                        y: {
                            stacked: true,
                            ticks: { color: '#003F5C' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: tooltipTitleCallback,
                                label: function(context) {
                                    if (context.dataset.label === 'Users') {
                                        let label = context.chart.data.labels[context.dataIndex];
                                        if (Array.isArray(label)) label = label.join(' ');
                                        return `${label}: ${context.parsed.x.toLocaleString()}`;
                                    }
                                    return null;
                                }
                            }
                        }
                    }
                }
            });
        };

        const updateTimeChart = (dataForYear) => {
            if (timeChart) timeChart.destroy();
            const ctx = document.getElementById('timeChart').getContext('2d');
            
            const sortedMonths = Object.keys(dataForYear).sort((a, b) => a - b);
            const labels = sortedMonths.map(monthIndex => monthNames[monthIndex]);
            const chartData = sortedMonths.map(monthIndex => dataForYear[monthIndex].conversion_rate);

            timeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Conversion Rate',
                        data: chartData,
                        borderColor: brilliantBlues[0],
                        backgroundColor: 'rgba(0, 63, 92, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: { color: '#003F5C' },
                            grid: { color: '#A7D1E3' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#003F5C', callback: (value) => `${(value * 100).toFixed(2)}%` },
                            grid: { color: '#A7D1E3' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: tooltipTitleCallback,
                                label: function(context) {
                                    return `${context.dataset.label}: ${(context.parsed.y * 100).toFixed(2)}%`;
                                }
                            }
                        }
                    }
                }
            });
        };
        
        const updateTimeChartForYear = (dataForYear) => {
            if (timeChart) timeChart.destroy();
            const ctx = document.getElementById('timeChart').getContext('2d');
            
            const sortedMonths = Object.keys(dataForYear).sort((a, b) => a - b);
            const labels = sortedMonths.map(monthIndex => monthNames[monthIndex]);
            const chartData = sortedMonths.map(monthIndex => dataForYear[monthIndex].conversion_rate);
            
            timeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Conversion Rate',
                        data: chartData,
                        backgroundColor: brilliantBlues,
                        borderColor: brilliantBlues[0],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return `${(value * 100).toFixed(2)}%`;
                                }
                            },
                            title: {
                                display: true,
                                text: 'Conversion Rate'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += (context.parsed.y * 100).toFixed(2) + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        };

        const handleFile = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    rawData = processCSV(event.target.result);
                    groupedData = groupDataByYearAndMonth(rawData);
                    
                    if (Object.keys(groupedData).length === 0) {
                         fileStatus.textContent = 'Error: No valid data could be processed from the CSV.';
                         fileStatus.classList.remove('text-gray-500');
                         fileStatus.classList.add('text-red-500');
                         dashboardContent.classList.add('hidden');
                         return;
                    }

                    populateDropdowns(groupedData);
                    updateDashboard();
                    fileStatus.textContent = `File "${file.name}" loaded successfully.`;
                    fileStatus.classList.remove('text-red-500');
                    fileStatus.classList.add('text-green-500');
                } catch (error) {
                    console.error(error);
                    fileStatus.textContent = `Error: ${error.message}`;
                    fileStatus.classList.remove('text-gray-500');
                    fileStatus.classList.add('text-red-500');
                    dashboardContent.classList.add('hidden');
                }
            };
            reader.readAsText(file);
        };

        fileInput.addEventListener('change', handleFile);
        yearSelect.addEventListener('change', () => {
            populateDropdowns(groupedData);
            updateDashboard();
        });
        monthSelect.addEventListener('change', updateDashboard);
    </script>
</body>
</html>
